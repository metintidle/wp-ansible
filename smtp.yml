---
- name: Setup SMTP for Wordpress Press on Amazon Linux 2
  hosts: all


  tasks:
    - name: Install Postfix
      command: yum install postfix -y
      ignore_errors: yes
      become: yes

    - name: Start and enable Postfix service
      systemd:
        name: postfix
        state: started
        enabled: yes
      become: yes

    - name: Check if Postfix is running
      command: systemctl status postfix
      register: postfix_status
      ignore_errors: yes
      become: yes

    - name: Check if WP-CLI is already installed
      stat:
        path: /usr/local/bin/wp
      register: wp_cli_installed
      become: yes

    - name: Download WP-CLI
      get_url:
          url: https://github.com/wp-cli/wp-cli/releases/download/v2.11.0/wp-cli-2.11.0.phar
          dest: /usr/local/bin/wp-cli.phar
          mode: "0755"
      become: yes
      when: not wp_cli_installed.stat.exists

    - name: List details of wp-cli.phar
      command: ls -al /usr/local/bin/wp-cli.phar
      register: wp_cli_phar_details
      become: yes
      when: not wp_cli_installed.stat.exists

    - name: Display wp-cli.phar details
      debug:
        var: wp_cli_phar_details.stdout
      become: yes
      when: not wp_cli_installed.stat.exists


    - name: Move WP-CLI to /usr/local/bin/wp
      command: mv /usr/local/bin/wp-cli.phar /usr/local/bin/wp
      become: yes
      when: not wp_cli_installed.stat.exists

    - name: Install WP MAIL SMTP Plugin
      command: /usr/local/bin/wp plugin install wp-mail-smtp --activate
      args:
        chdir: /home/ec2-user/html

    - name: Add SMTP configuration to wp-config.php
      lineinfile:
        path: /home/ec2-user/html/wp-config.php
        line: "{{ item }}"
        create: yes
      with_items:
        - "define('SMTP_USER', '{{lookup('env', 'SMTP_USER')}}');"
        - "define('SMTP_PASS', '{{lookup('env', 'SMTP_PASS')}}');"
        - "define('SMTP_HOST', 'smtp.office365.com');"
        - "define('SMTP_PORT', '587');"
        - "define('SMTP_SECURE', 'tls');"

    - name: check SMTP functionality
      command: wp mail test "mahdi@itt.com.au" --subject="Test Email" --message="This is a test message."
      args:
        chdir: /home/ec2-user/html

