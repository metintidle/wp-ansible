---
 - name: Setup image plugin for fixing upload issues
   hosts: all
   become: yes
   gather_facts: false
   vars:
     # Let Ansible auto-detect the best Python on the remote
     ansible_python_interpreter: auto_silent
     # Provide a safe default for the web user
     web_user: "{{ ansible_user | default('ec2-user') }}"

   pre_tasks:
     - name: Ensure Python 3 is present for Ansible modules
       raw: test -x /usr/bin/python3 || (command -v dnf >/dev/null 2>&1 && sudo dnf -y install python3) || (command -v yum >/dev/null 2>&1 && sudo yum -y install python3) || (command -v apt-get >/dev/null 2>&1 && sudo apt-get update -y && sudo apt-get install -y python3)
       changed_when: false
       become: yes

   tasks:

     - name: Install Image packages
       package:
         name:
           - gcc
           - ImageMagick
           - ImageMagick-devel
           - libwebp-tools
           - netpbm-progs
           - libjpeg-turbo-utils
         state: present
       register: pkg_result
       failed_when: false  # Some names may not exist on all distros; continue
       changed_when: pkg_result is changed

     - name: Compress the wp-maintence plugin folder locally
       community.general.archive:
         path: plugins/wp-maintence # Relative path to the plugin on your machine
         dest: /tmp/wp-maintence.tar.gz
         format: gz
       delegate_to: localhost
       become: false
       run_once: true

     - name: Upload the compressed plugin to the remote server
       ansible.builtin.copy:
         src: /tmp/wp-maintence.tar.gz
         dest: /tmp/wp-maintence.tar.gz
         mode: '0644'

     - name: Uncompress the plugin on the remote server
       ansible.builtin.unarchive:
         src: /tmp/wp-maintence.tar.gz
         dest: /home/ec2-user/html/wp-content/plugins/
         remote_src: yes # Tells Ansible the source is on the remote machine
         owner: "{{ web_user }}"
         group: nginx

     - name: Clean up the archive on the remote server
       ansible.builtin.file:
         path: /tmp/wp-maintence.tar.gz
         state: absent

     - name: Clean up the local archive on the controller
       ansible.builtin.file:
         path: /tmp/wp-maintence.tar.gz
         state: absent
       delegate_to: localhost
       become: false
       run_once: true
