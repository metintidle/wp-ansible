# Strict path whitelist - Map definitions (http context)
# Deploy to: /etc/nginx/conf.d/strict-whitelist-maps.conf
#
# Purpose: Block all requests except whitelisted paths for anonymous visitors.
# Logged-in users (WordPress cookie) bypass the whitelist entirely.
#
# Site: aprfamilypractice.com (or similar small fixed-content sites)

# 1. Logged-in bypass: skip whitelist if WordPress cookie present
map $http_cookie $strict_skip {
  default 0;
  "~*wordpress_logged_in" 1;
}

# 2. Path whitelist: allowed pages for anonymous users
map $uri $strict_path_ok {
  default 0;
  
  # Public pages (pretty URLs)
  "~^/?$" 1;                              # home page
  "~^/contact-us/?$" 1;                   # contact page
  "~^/our-services/?$" 1;                 # services page
  
  # Custom login URL
  "~^/modri/?$" 1;                        # custom WordPress login
  
  # WordPress AJAX and REST API (needed for contact forms and front-end features)
  "~^/wp-admin/admin-ajax\.php$" 1;       # AJAX handler
  "~^/wp-json/" 1;                        # REST API (prefix match)
  
  # Optional: WordPress cron and SEO files
  "~^/wp-cron\.php$" 1;                   # scheduled tasks
  "~^/robots\.txt$" 1;                    # SEO
  "~^/favicon\.ico$" 1;                   # favicon
  "~^/sitemap" 1;                         # sitemaps (prefix match for sitemap.xml, sitemap_index.xml, etc.)
}

# 3. Static files: allow by extension (expanded list)
map $uri $strict_static_ok {
  default 0;
  "~*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp|avif|pdf|mp4|webm|ogg|mp3|wav)$" 1;
  "~*\.(map|json|xml|txt|webmanifest)$" 1;
}

# 4. Combined allow: path OR static
map "$strict_path_ok$strict_static_ok" $strict_allow {
  default 0;
  "01" 1;   # static allowed
  "10" 1;   # path allowed
  "11" 1;   # both allowed
}

# 5. Final deny decision: deny if (not logged in) AND (not allowed)
#    Nginx if doesn't support &&, so we combine into one variable
map "$strict_skip$strict_allow" $strict_deny {
  default 0;
  "00" 1;   # strict_skip=0 (not logged in) AND strict_allow=0 (not allowed) -> DENY
}
