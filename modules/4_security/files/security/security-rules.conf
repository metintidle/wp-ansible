# CRITICAL: Block malicious PHP files FIRST (before any other processing)
# This must be at the top to prevent "Primary script unknown" errors
# Based on actual attack patterns from nginx error logs
location ~* ^/(wp-good|ioxi-o|file|gmb|configwidgets|alive|get|dhlshipments|index4|panelx|phpinfo|info|test|shell|c99|r57|webshell|backdoor|admin|config|database|db|mysql|upload|uploader|wso|alfa|bypass|exploit|hack|payload|cmd|terminal|console|mda|cheka|cabs|login|htaccess|randkeyword|fwe|zwso|class-t\.api|class19|class20|tx1|xv|x56|g|app_dev)\.php$ {
  return 403;
}

# Block malicious plugin files (fake plugins used for exploits)
location ~* ^/wp-content/plugins/.+/(wp_filemanager|file_manager|filemanager|fm|shell|backdoor|upload)\.php$ {
  return 403;
}

# Security headers
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header X-Content-Type-Options "nosniff" always;
# add_header Referrer-Policy "strict-origin-when-cross-origin" always;
# add_header Content-Security-Policy "default-src 'self' https: data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: https://*.elementor.com https://*.googleapis.com https://code.jquery.com https://www.google.com https://www.gstatic.com https://plugins.nowbookit.com; style-src 'self' 'unsafe-inline' https://*.googleapis.com; font-src 'self' data: https://*.gstatic.com; img-src 'self' data: https:; connect-src 'self' https:; worker-src 'self' blob:;" always;
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
# add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
# add_header X-Permitted-Cross-Domain-Policies "none" always;

# Rate limiting (only applied to specific locations, not globally)
# Note: Rate limit zones must be defined in main nginx.conf:
# limit_req_zone $binary_remote_addr zone=security_login:10m rate=5r/m;
# limit_req_zone $binary_remote_addr zone=security_api:10m rate=30r/m;
# limit_req_zone $binary_remote_addr zone=global_limit:10m rate=10r/s;

# Block bad bots (excluding legitimate tools)
if ($http_user_agent ~* (nikto|sqlmap|havij|nmap|nessus|whatweb|Openvas|jbrofuzz|w3af|acunetix|masscan|zgrab)) {
  return 403;
}

# Block WordPress user enumeration
if ($args ~* "author=\d+") {
  return 403;
}
# Block XML-RPC attacks
location = /xmlrpc.php {
  deny all;
  return 403;
}

# Protect wp-login.php with strict rate limiting
location = /wp-login.php {
  limit_req zone=security_login burst=5 nodelay;
  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/var/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  fastcgi_param PATH_INFO $fastcgi_path_info;
}

# Rate limit WordPress admin AJAX (only for admin-ajax.php)
# Also set cache bypass so this works with cache_block.conf (no duplicate location there)
location = /wp-admin/admin-ajax.php {
  limit_req zone=security_api burst=20 nodelay;
  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/var/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  fastcgi_cache_bypass 1;
  fastcgi_no_cache 1;
  add_header X-Cache-Status "BYPASS-AJAX";
  add_header Cache-Control "no-cache, no-store, must-revalidate";
}

# Allow admin-post.php (WordPress form handler)
location = /wp-admin/admin-post.php {
  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/var/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}


# Block readme.html (version disclosure)
location = /readme.html {
  deny all;
  return 403;
}

# Block install.php after installation
location = /wp-admin/install.php {
  deny all;
  return 403;
}

# Block direct access to most wp-includes PHP files
location ~ ^/wp-includes/(?!js/tinymce/langs/).*\.php$ {
  deny all;
  return 403;
}

# Block access to sensitive files
location ~ /\.(env|git|htaccess|config\.json|composer\.json|composer\.lock|package\.json|package-lock\.json|svn|hg|bzr)$ {
  deny all;
  return 403;
}

# Serve static files (including fonts and SVGs)
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
  expires max;
  log_not_found off;
  add_header Cache-Control "public, immutable";
}

# Block suspicious PHP files
location ~* /(eval-stdin|phpunit|wp-config-sample|php-backdoor|shell|c99|r57|webshell)\.php$ {
  deny all;
  return 403;
}

# Block vendor/composer directories (PHPUnit exploits, etc.) - BEFORE they reach PHP-FPM
location ~* ^/(vendor|composer|node_modules)/ {
  deny all;
  return 403;
}

# Block common exploit paths and scan tools (specific known malware)
location ~* ^/(ALFA_DATA|alfacgiapi|\.env\.php|wp-plain\.php|kdylvcde\.php) {
  deny all;
  return 403;
}
# Block PHP execution in wp-content/cache directory (security) but allow HTML serving
location ~ ^/wp-content/cache/.*\.php$ {
  deny all;
  return 403;
}

# Block direct directory browsing of cache folder
location ~ ^/wp-content/cache/$ {
  deny all;
  return 403;
}

# NOTE: WP Super Cache configuration
# The $cache_uri variable and location / block with try_files must be in your main nginx.conf
# The variable setup and location / block are already configured in your server block

# Disable directory listing
autoindex off;

# Deny access to hidden files
location ~ /\. {
  deny all;
  return 403;
}

# Block PHP execution in uploads directory
location ~ ^/wp-content/uploads/.*\.php$ {
  deny all;
  return 403;
}

# Block common exploits
location ~* wp-config.php$ {
  deny all;
}
location ~* wp-config-sample\.php$ {
  deny all;
}
location ~* phpinfo.php$ {
  deny all;
  return 403;
}
location ~* config.php$ {
  deny all;
}
location ~* shell\.php$ {
  deny all;
  return 403;
}
location ~* repeater\.php$ {
  deny all;
  return 403;
}

# NOTE: WP Super Cache security blocks above (lines 107-117)
# Block PHP execution and directory browsing in wp-content/cache/

# Block debug and backup files
location ~* \.(log|sql|tar|gz|zip|bak|old|tmp|temp|swp|ini|bkp)$ {
  deny all;
  return 403;
}

# EARLY BLOCKING: Block malicious PHP files before they reach location /
# This prevents "Primary script unknown" errors by blocking with 403 early
# Matches PHP files outside WordPress core paths (before try_files processing)

# Block PHP files in non-WordPress paths (admin/, vendor/, .well-known/, etc.)
location ~ ^/(admin|vendor|\.well-known|api|backup|bak|old|tmp|test|upload|uploads|files|data|config)/.*\.php$ {
  return 403;  # Forbidden - logged for Fail2Ban detection
}

# Block PHP in wp-content/plugins with suspicious paths
# Example: /wp-content/plugins/hellopress/wp_filemanager.php (not a real plugin)
location ~ ^/wp-content/plugins/[^/]+/(?!.*/(admin|includes|templates)/).*\.(php|phtml|php3|php4|php5|phar)$ {
  # Only allow index.php in plugin root and PHP files in specific subdirectories
  if ($uri !~ "^/wp-content/plugins/[^/]+/index\.php$") {
    return 403;
  }
}

# Allow wp-cron.php (WordPress cron handler)
location = /wp-cron.php {
  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/var/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}

# Allow index.php (main WordPress entry point)
location = /index.php {
  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/var/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  fastcgi_param PATH_INFO $fastcgi_path_info;
}

# Handle WordPress admin area PHP files (wp-admin/*.php)
# Exclude admin-ajax.php and admin-post.php (handled by dedicated blocks above with rate limiting)
location ~ ^/wp-admin/(?!admin-ajax\.php|admin-post\.php).*\.php$ {
  # Block known malicious admin PHP files
  if ($uri ~* "^/wp-admin/(install|setup-config|repair)\.php$") {
    return 403;
  }

  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/var/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}

# CATCH-ALL: Block ALL other PHP files not explicitly allowed above
# This is the final defense - any PHP file that reaches here is blocked
location ~ \.php$ {
  return 403;
}

# # Block root-level malicious PHP files (except WordPress essentials)
# location ~ ^/[a-zA-Z0-9_-]+\.php$ {
#   # Only allow these specific root-level PHP files
#   if ($request_uri ~* "^/(index|wp-login|wp-cron)\.php$") {
#     set $allow_root_php 1;
#   }
#   if ($allow_root_php != 1) {
#     return 403;  # Forbidden - logged for Fail2Ban detection
#   }
#   # If allowed, continue to main PHP handler below
# }

# # Block direct access to ALL PHP files except essential WordPress files
# # This works with pretty URLs since WordPress routes everything through index.php
# location ~ \.php$ {
#   # Allow essential WordPress PHP files
#   if ($request_uri ~* "^/(index\.php|wp-login\.php|wp-admin/.*\.php|wp-cron\.php)$") {
#     set $allow_php 1;
#   }

#   # Allow admin-ajax.php (already handled above with rate limiting)
#   if ($request_uri = "/wp-admin/admin-ajax.php") {
#     set $allow_php 1;
#   }

#   # Allow WP-CLI and WordPress core AJAX handlers
#   if ($request_uri = "/wp-admin/admin-post.php") {
#     set $allow_php 1;
#   }

#   # Block all other PHP files
#   if ($allow_php != 1) {
#     return 403;
#   }

#   # Process allowed PHP files
#   try_files $uri =404;
#   fastcgi_split_path_info ^(.+\.php)(/.+)$;
#   fastcgi_pass unix:/var/run/php-fpm/www.sock;
#   fastcgi_index index.php;
#   include fastcgi_params;
#   fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
#   fastcgi_param PATH_INFO $fastcgi_path_info;
# }
