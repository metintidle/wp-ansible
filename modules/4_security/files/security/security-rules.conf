
# =============================================================================
# SECTION 1: BLOCK MALICIOUS PHP FILES (must be first - highest priority)
# =============================================================================

# Block known malicious root-level PHP shells and backdoors
location ~* ^/(wp-good|ioxi-o|file|gmb|configwidgets|alive|get|dhlshipments|index4|panelx|phpinfo|info|test|shell|c99|r57|webshell|backdoor|admin|config|database|db|mysql|upload|uploader|wso|alfa|bypass|exploit|hack|payload|cmd|terminal|console|mda|cheka|cabs|htaccess|randkeyword|fwe|zwso|class-t\.api|class19|class20|tx1|xv|x56|g|app_dev)\.php$ {
  deny all;
  return 403;
}

# Block malicious plugin files (fake plugins used for exploits)
location ~* ^/wp-content/plugins/.+/(wp_filemanager|file_manager|filemanager|fm|shell|backdoor|upload)\.php$ {
  deny all;
  return 403;
}

# Block known malicious paths and exploit kits
location ~* ^/(ALFA_DATA|alfacgiapi|\.env\.php|wp-plain\.php|kdylvcde\.php) {
  deny all;
  return 403;
}

# Block vendor/composer/node_modules directories (PHPUnit RCE exploits)
location ~* ^/(vendor|composer|node_modules)/ {
  deny all;
  return 403;
}

# Block PHP in non-WordPress paths
location ~ ^/(api|backup|bak|old|tmp|test|upload|files|data|config)/.*\.php$ {
  deny all;
  return 403;
}


# =============================================================================
# SECTION 2: BLOCK SENSITIVE FILES & DIRECTORIES
# =============================================================================

# Block hidden files and directories (.env, .git, .htaccess, etc.)
location ~ /\. {
  deny all;
  return 403;
}

# Block access to sensitive config/lock files
location ~ /\.(env|git|htaccess|config\.json|composer\.json|composer\.lock|package\.json|package-lock\.json|svn|hg|bzr)$ {
  deny all;
  return 403;
}

# Block wp-config.php and variants
location ~* wp-config.*\.php$ {
  deny all;
  return 403;
}

# Block debug and backup files
location ~* \.(log|sql|tar|gz|zip|bak|old|tmp|temp|swp|ini|bkp)$ {
  deny all;
  return 403;
}

# Block common exploits and sensitive file extensions
location ~* \.(git|svn|hg|exe|bat|sh)$ {
  deny all;
  return 403;
}

# Block version disclosure
location = /readme.html { deny all; return 403; }
location = /license.txt { deny all; return 403; }
location ~* phpinfo\.php$ { deny all; return 403; }

# Block XML-RPC attacks
location = /xmlrpc.php {
  deny all;
  return 403;
}

# Block WordPress install/setup after installation
location = /wp-admin/install.php   { deny all; return 403; }
location = /wp-admin/setup-config.php { deny all; return 403; }

# Block REST API user enumeration
location = /wp-json/wp/v2/users {
  deny all;
  return 403;
}

# Block PHP execution in uploads directory (SECURITY CRITICAL)
location ~ ^/wp-content/uploads/.*\.php$ {
  deny all;
  return 403;
}

# Block PHP execution in cache directory
location ~ ^/wp-content/cache/.*\.php$ {
  deny all;
  return 403;
}

# Block PHP in wp-includes (allow only essential core files)
location ~ ^/wp-includes/(?!js/tinymce/langs/).*\.php$ {
  deny all;
  return 403;
}

# Block sensitive wp-admin subdirectories
location ~ ^/wp-admin/(includes|network)/.*\.php$ {
  deny all;
  return 403;
}

# Block suspicious PHP files
location ~* /(eval-stdin|phpunit|wp-config-sample|php-backdoor)\.php$ {
  deny all;
  return 403;
}


# =============================================================================
# SECTION 3: STATIC ASSETS (cached, no PHP processing needed)
# =============================================================================

location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
  expires max;
  access_log off;
  log_not_found off;
  add_header Cache-Control "public, immutable";
}


# =============================================================================
# SECTION 4: WORDPRESS PHP HANDLERS (explicit allowed PHP entry points)
# =============================================================================

# WordPress main entry point - MUST pass to PHP (fixes file download bug)
location = /index.php {
  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  fastcgi_param PATH_INFO $fastcgi_path_info;
}

# WordPress cron
location = /wp-cron.php {
  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}

# wp-login.php with strict rate limiting (security_login = 2r/m)
location = /wp-login.php {
  limit_req zone=security_login burst=5 nodelay;
  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  fastcgi_param PATH_INFO $fastcgi_path_info;
}

# Elementor AJAX + admin-ajax with rate limiting (security_api = 10r/s)
location = /wp-admin/admin-ajax.php {
  limit_req zone=security_api burst=20 nodelay;
  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  fastcgi_cache_bypass 1;
  fastcgi_no_cache 1;
  add_header X-Cache-Status "BYPASS-AJAX";
  add_header Cache-Control "no-cache, no-store, must-revalidate";
}

# WordPress form handler
location = /wp-admin/admin-post.php {
  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}

# wp-admin PHP files (excludes ajax/post handled above, blocks install/setup)
location ~ ^/wp-admin/(?!admin-ajax\.php|admin-post\.php|install\.php|setup-config\.php).*\.php$ {
  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}

# Plugin PHP files
location ~* ^/wp-content/plugins/.*\.php$ {
  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}

# Theme PHP files
location ~* ^/wp-content/themes/.*\.php$ {
  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}

# Elementor frontend editor REST API
location ~* ^/wp-json/elementor/ {
  try_files $uri $uri/ /index.php?$args;
}
