# Security headers
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header X-Content-Type-Options "nosniff" always;
# add_header Referrer-Policy "strict-origin-when-cross-origin" always;
# add_header Content-Security-Policy "default-src 'self' https: data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob: https://*.elementor.com https://*.googleapis.com https://code.jquery.com https://www.google.com https://www.gstatic.com https://plugins.nowbookit.com; style-src 'self' 'unsafe-inline' https://*.googleapis.com; font-src 'self' data: https://*.gstatic.com; img-src 'self' data: https:; connect-src 'self' https:; worker-src 'self' blob:;" always;
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
# add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
# add_header X-Permitted-Cross-Domain-Policies "none" always;

# Rate limiting (only applied to specific locations, not globally)
# Note: Rate limit zones must be defined in main nginx.conf:
# limit_req_zone $binary_remote_addr zone=security_login:10m rate=5r/m;
# limit_req_zone $binary_remote_addr zone=security_api:10m rate=30r/m;
# limit_req_zone $binary_remote_addr zone=global_limit:10m rate=10r/s;

# Block bad bots (excluding legitimate tools)
if ($http_user_agent ~* (nikto|sqlmap|havij|nmap|nessus|whatweb|Openvas|jbrofuzz|w3af|acunetix|masscan|zgrab)) {
  return 403;
}

# Block WordPress user enumeration
if ($args ~* "author=\d+") {
  return 403;
}
# Block XML-RPC attacks
location = /xmlrpc.php {
  deny all;
  access_log off;
  return 444;
}

# Protect wp-login.php with strict rate limiting
location = /wp-login.php {
  limit_req zone=security_login burst=5 nodelay;
  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/var/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  fastcgi_param PATH_INFO $fastcgi_path_info;
}

# Rate limit WordPress admin AJAX (only for admin-ajax.php)
location = /wp-admin/admin-ajax.php {
  limit_req zone=security_api burst=20 nodelay;
  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/var/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}

# Block readme.html (version disclosure)
location = /readme.html {
  deny all;
  return 404;
}

# Block install.php after installation
location = /wp-admin/install.php {
  deny all;
  return 404;
}

# Block direct access to most wp-includes PHP files
location ~ ^/wp-includes/(?!js/tinymce/langs/).*\.php$ {
  deny all;
  return 404;
}

# Block access to sensitive files
location ~ /\.(env|git|htaccess|config\.json|composer\.json|composer\.lock|package\.json|package-lock\.json|svn|hg|bzr)$ {
  deny all;
  return 404;
}

# Serve static files (including fonts and SVGs)
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
  expires max;
  access_log off;
  log_not_found off;
  add_header Cache-Control "public, immutable";
}

# Block suspicious PHP files
location ~* /(eval-stdin|phpunit|wp-config-sample|php-backdoor|shell|c99|r57|webshell)\.php$ {
  deny all;
  return 444;
}

# Block vendor/composer directories (PHPUnit exploits, etc.) - BEFORE they reach PHP-FPM
location ~* ^/(vendor|composer|node_modules)/ {
  deny all;
  access_log off;
  return 444;
}

# Block common exploit paths and scan tools
location ~* ^/(\.well-known/worksec\.php|ALFA_DATA|alfacgiapi|\.env\.php|wp-plain\.php|kdylvcde\.php) {
  deny all;
  access_log off;
  return 444;
}
# Block PHP execution in wp-content/cache directory (security) but allow HTML serving
location ~ ^/wp-content/cache/.*\.php$ {
  deny all;
  return 404;
}

# Block direct directory browsing of cache folder
location ~ ^/wp-content/cache/$ {
  deny all;
  return 404;
}

# NOTE: WP Super Cache configuration
# The $cache_uri variable and location / block with try_files must be in your main nginx.conf
# The variable setup and location / block are already configured in your server block

# Disable directory listing
autoindex off;

# Deny access to hidden files
location ~ /\. {
  deny all;
}

# Block PHP execution in uploads directory
location ~ ^/wp-content/uploads/.*\.php$ {
  deny all;
  return 404;
}

# Block common exploits
location ~* wp-config.php$ {
  deny all;
}
location ~* wp-config-sample\.php$ {
  deny all;
}
location ~* phpinfo.php$ {
  deny all;
}
location ~* config.php$ {
  deny all;
}
location ~* shell\.php$ {
  deny all;
}
location ~* repeater\.php$ {
  deny all;
}

# NOTE: WP Super Cache security blocks above (lines 107-117)
# Block PHP execution and directory browsing in wp-content/cache/

# Block debug and backup files
location ~* \.(log|sql|tar|gz|zip|bak|old|tmp|temp|swp|ini|bkp)$ {
  deny all;
  return 404;
}

# Block direct access to ALL PHP files except essential WordPress files
# This works with pretty URLs since WordPress routes everything through index.php
location ~ \.php$ {
  # Allow essential WordPress PHP files
  if ($request_uri ~* "^/(index\.php|wp-login\.php|wp-admin/.*\.php|wp-cron\.php)$") {
    set $allow_php 1;
  }

  # Allow admin-ajax.php (already handled above with rate limiting)
  if ($request_uri = "/wp-admin/admin-ajax.php") {
    set $allow_php 1;
  }

  # Allow WP-CLI and WordPress core AJAX handlers
  if ($request_uri = "/wp-admin/admin-post.php") {
    set $allow_php 1;
  }

  # Block all other PHP files
  if ($allow_php != 1) {
    return 403;
  }

  # Process allowed PHP files
  try_files $uri =404;
  fastcgi_split_path_info ^(.+\.php)(/.+)$;
  fastcgi_pass unix:/var/run/php-fpm/www.sock;
  fastcgi_index index.php;
  include fastcgi_params;
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  fastcgi_param PATH_INFO $fastcgi_path_info;
}
