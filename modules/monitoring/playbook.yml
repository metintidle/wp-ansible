---
- name: Create WP-CLI and cron job for WP Maintenance or security agent
  hosts: all
  vars:
    my_site_id: "{{ my_site| replace(' ', '_')  }}" # Use the inventory IP for the site URL

  tasks:
    - name: Check if WP-CLI is already installed
      stat:
        path: /usr/local/bin/wp
      register: wp_cli_installed
      become: yes

    - name: Download WP-CLI (latest version)
      get_url:
        url: https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
        dest: /usr/local/bin/wp-cli.phar
        mode: "0755"
      become: yes
      when: not wp_cli_installed.stat.exists

    - name: List details of wp-cli.phar
      command: ls -al /usr/local/bin/wp-cli.phar
      register: wp_cli_phar_details
      become: yes
      when: not wp_cli_installed.stat.exists

    - name: Display wp-cli.phar details
      debug:
        var: wp_cli_phar_details.stdout
      when: not wp_cli_installed.stat.exists

    - name: Move WP-CLI to /usr/local/bin/wp
      command: mv /usr/local/bin/wp-cli.phar /usr/local/bin/wp
      become: yes
      when: not wp_cli_installed.stat.exists

    # Allow ec2-user to run WP-CLI with sudo (e.g. sudo wp plugin list ...)
    - name: Deploy sudoers rule for WP-CLI (sudo wp without password)
      copy:
        src: files/sudoers-wp-cli
        dest: /etc/sudoers.d/wp-cli
        mode: "0440"
        validate: "visudo -cf %s"
      become: yes

    - name: Install jq for JSON processing
      yum:
        name: jq
        state: present
      become: yes

    - name: Copy wp-agent-wp.sh to /usr/local/bin
      copy:
        src: scripts/wp-agent-wp.sh
        dest: /usr/local/bin/wp-agent-wp.sh
        mode: "0755"
        owner: root
        group: root
      become: yes

    - name: Copy wp-agent-root.sh to /usr/local/bin
      copy:
        src: scripts/wp-agent-root.sh
        dest: /usr/local/bin/wp-agent-root.sh
        mode: "0755"
        owner: root
        group: root
      become: yes

    - name: Create state directory for wp-agent (root)
      file:
        path: /var/lib/wp-agent
        state: directory
        mode: "0755"
        owner: root
        group: root
      become: yes

    - name: Create plugins directory for wp-agent (ec2-user writable)
      file:
        path: /var/lib/wp-agent/plugins
        state: directory
        mode: "0755"
        owner: ec2-user
        group: ec2-user
      become: yes

    - name: Create cron job for wp-agent-wp.sh (WP-CLI, runs 30 min before root)
      cron:
        name: "wp agent wp-cli (plugins)"
        user: ec2-user
        hour: "5,13,21"
        minute: "30"
        job: "STATE_DIR=/var/lib/wp-agent WP_PATH=/usr/share/nginx/html /usr/local/bin/wp-agent-wp.sh --site-id {{ my_site_id }} --site-name {{ my_site }}"
      become: yes

    - name: Create cron job for wp-agent-root.sh (nginx, fail2ban, POST)
      cron:
        name: "wp agent root (report)"
        user: root
        hour: "6,14,22"
        minute: "0"
        job: "/usr/local/bin/wp-agent-root.sh --site-id {{ my_site_id }} --site-name {{ my_site }}"
      become: yes

